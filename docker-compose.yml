services:
  # --- 1. O SITE (LARAVEL + PHP) ---
  app:
    build:
      context: .
      dockerfile: Dockerfile.laravel
    image: foconopreco-app
    container_name: foconopreco_app
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - .:/var/www
    environment:
      - SENTRY_LARAVEL_DSN=${SENTRY_LARAVEL_DSN}
    networks:
      - foconopreco-network
    secrets:
      - db_password
      - sentry_auth_token

  # --- 2. O SERVIDOR WEB (NGINX) ---
  webserver:
    image: nginx:alpine
    container_name: foconopreco_webserver
    restart: unless-stopped
    ports:
      - "80:80" # Porta pública do site (única aberta para a internet)
    volumes:
      - .:/var/www
      - ./docker/nginx:/etc/nginx/conf.d
    depends_on:
      - app
    networks:
      - foconopreco-network

  # --- 3. O BANCO DE DADOS (MYSQL) ---
  db:
    image: mysql:8.0
    container_name: foconopreco_db
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MYSQL_PASSWORD_FILE: /run/secrets/db_password
      MYSQL_USER: ${DB_USERNAME}
      TZ: America/Sao_Paulo
    ports:
      # SEGURANÇA: Vincula apenas ao localhost (127.0.0.1)
      # Bloqueia acesso direto via IP externo
      - "127.0.0.1:3306:3306"
    volumes:
      - dbdata:/var/lib/mysql
    networks:
      - foconopreco-network
    secrets:
      - db_root_password
      - db_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 20s
      retries: 10

  # --- 4. PHPMYADMIN ---
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: foconopreco_pma
    environment:
      PMA_HOST: db
      PMA_USER: root
      PMA_PASSWORD_FILE: /run/secrets/db_root_password
      UPLOAD_LIMIT: 64M
    ports:
      # SEGURANÇA: Apenas localhost. 
      # Para acessar, use Tunel SSH: ssh -L 8080:localhost:8080 user@ip-servidor
      - "127.0.0.1:8080:80"
    depends_on:
      - db
    networks:
      - foconopreco-network
    secrets:
      - db_root_password

  # --- 5. REDIS (FILAS) ---
  redis:
    image: redis:alpine
    container_name: foconopreco_redis
    restart: unless-stopped
    ports:
      # SEGURANÇA: Apenas localhost
      - "127.0.0.1:6379:6379"
    networks:
      - foconopreco-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 10s
      retries: 5

  # --- 6. WORKERS CELERY ---
  worker_scrape:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: worker_scrape
    command: python3 -m celery -A python_services.scraping.celery_app worker --loglevel=info -Q fila_scrape --concurrency=10
    volumes:
      - .:/app
    env_file: .env
    environment:
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password
      - brightdata_user      
      - brightdata_password

  worker_ia:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: worker_ia
    command: python3 -m celery -A python_services.scraping.celery_app worker --loglevel=info -Q fila_ia --concurrency=2
    volumes:
      - .:/app
    env_file: .env
    environment:
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password
      - gemini_api_key

  worker_conteudo:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: worker_conteudo
    command: python3 -m celery -A python_services.content_ia.celery_app_conteudo worker --loglevel=info -Q fila_conteudo --concurrency=2
    volumes:
      - .:/app
    env_file: .env
    environment:
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password
      - gemini_api_key
      - google_api_key

  # --- 7. ROBÔS SCRIPTS ---
  coletor_scrape:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: coletor_scrape
    command: python3 -u python_services/scraping/coletor.py
    volumes:
      - .:/app
    env_file: .env
    environment:
      - PYTHONPATH=/app
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password

  coletor_ia:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: coletor_ia
    command: python3 -u python_services/scraping/coletor_ia.py
    volumes:
      - .:/app
    env_file: .env
    environment:
      - PYTHONPATH=/app
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password

  coletor_conteudo:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: coletor_conteudo
    command: python3 -u python_services/content_ia/coletor_conteudo.py
    volumes:
      - .:/app
    env_file: .env
    environment:
      - PYTHONPATH=/app
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password

  produtor_conteudo:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: produtor_conteudo
    command: python3 -u python_services/content_ia/produtor_conteudo.py
    volumes:
      - .:/app
    env_file: .env
    environment:
      - PYTHONPATH=/app
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password

  produtor_scrape:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: produtor_scrape
    command: python3 -u python_services/scraping/produtor.py
    volumes:
      - .:/app
    env_file: .env
    environment:
      - PYTHONPATH=/app
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password

  produtor_ia:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: produtor_ia
    command: python3 -u python_services/scraping/produtor_ia.py
    volumes:
      - .:/app
    env_file: .env
    environment:
      - PYTHONPATH=/app
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password

  worker_backup:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: worker_backup
    command: python3 -u python_services/backup/backup_drive.py
    volumes:
      - .:/app
      - ./service_account.json:/app/service_account.json
    env_file: .env
    environment:
      - DB_HOST=db
      - SENTRY_DSN=${SENTRY_LARAVEL_DSN}
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - foconopreco-network
    secrets:
      - db_password

# --- STACK DE MONITORAMENTO ---

  prometheus:
    image: prom/prometheus:latest
    container_name: foconopreco_prometheus
    restart: unless-stopped
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "127.0.0.1:9090:9090" # Protegido contra acesso externo
    networks:
      - foconopreco-network

  grafana:
    image: grafana/grafana:latest
    container_name: foconopreco_grafana
    restart: unless-stopped
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_password
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    ports:
      - "3000:3000" # Mantido público para acesso ao dashboard (proteja com senha forte!)
    depends_on:
      - prometheus
    networks:
      - foconopreco-network
    secrets:
      - grafana_password

  redis-exporter:
    image: oliver006/redis_exporter
    container_name: foconopreco_redis_exporter
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis://redis:6379
    depends_on:
      - redis
    networks:
      - foconopreco-network

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.0
    container_name: foconopreco_cadvisor
    restart: unless-stopped
    privileged: true
    # Correção essencial para leitura de métricas em hosts modernos
    cgroupns: host
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    devices:
      - /dev/kmsg
    ports:
      - "127.0.0.1:8081:8080" # Protegido contra acesso externo
    networks:
      - foconopreco-network

# --- DECLARAÇÃO GLOBAL DOS SECRETS ---
networks:
  foconopreco-network:
    driver: bridge

volumes:
  dbdata:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

secrets:
  db_password:
    file: ./secrets/db_password.txt
  db_root_password:
    file: ./secrets/db_root_password.txt
  gemini_api_key:       
    file: ./secrets/gemini_api_key.txt
  
  # --- NOVOS SECRETS ---
  grafana_password:
    file: ./secrets/grafana_password.txt
  brightdata_user:
    file: ./secrets/brightdata_user.txt
  brightdata_password:
    file: ./secrets/brightdata_password.txt
  sentry_auth_token:
    file: ./secrets/sentry_auth_token.txt